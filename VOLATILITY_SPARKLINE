/**
 * Calculates 30-day rolling volatility for a sparkline.
 * Usage: =SPARKLINE(VOLATILITY_SPARKLINE("MSTR"))
 * @param {string} ticker The ticker symbol in B2.
 */
function VOLATILITY_SPARKLINE(ticker) {
  if (!ticker) return;
  initializeCredentials(); // Ensure keys are loaded
  const headers = { "APCA-API-KEY-ID": ALPAC_API_KEY_ID, "APCA-API-SECRET-KEY": ALPAC_API_SECRET_KEY };
  
  try {
    // Fetch 45 days to ensure we have at least 30 trading days
    const url = `https://data.alpaca.markets/v2/stocks/${ticker}/bars?timeframe=1Day&limit=45&adjustment=all`;
    const resp = UrlFetchApp.fetch(url, { "headers": headers });
    const bars = JSON.parse(resp.getContentText()).bars;
    if (!bars || bars.length < 31) return "Need more data";

    // 1. Calculate daily percentage returns
    let returns = [];
    for (let i = 1; i < bars.length; i++) {
      let dailyReturn = (bars[i].c - bars[i-1].c) / bars[i-1].c;
      returns.push(dailyReturn);
    }

    // 2. Calculate rolling 30-day volatility (standard deviation of returns)
    let volHistory = [];
    const windowSize = 30;
    
    for (let i = 0; i <= returns.length - windowSize; i++) {
      let window = returns.slice(i, i + windowSize);
      let mean = window.reduce((a, b) => a + b) / windowSize;
      let variance = window.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (windowSize - 1);
      let stdev = Math.sqrt(variance);
      
      // Annualize it (optional, but standard for volatility)
      let annualizedVol = stdev * Math.sqrt(252); 
      volHistory.push(annualizedVol);
    }

    return volHistory; // Returns an array that SPARKLINE can read
  } catch (e) {
    return "Error: " + e.message;
  }
}
