/**
 * Calculates 30-day rolling volatility for a sparkline.
 * Returns a simple array of values to satisfy SPARKLINE requirements.
 */
function VOLATILITY_SPARKLINE(ticker) {
  if (!ticker || ticker === "") return [];
  
  // Initialize credentials from apikeys.gs
  if (typeof ALPAC_API_KEY_ID === 'undefined') {
    try { initializeCredentials(); } catch(e) {}
  }

  const apiKey = typeof ALPAC_API_KEY_ID !== 'undefined' ? ALPAC_API_KEY_ID : "";
  const apiSecret = typeof ALPAC_API_SECRET_KEY !== 'undefined' ? ALPAC_API_SECRET_KEY : "";
  
  if (!apiKey) return "Missing API Keys";

  const headers = { "APCA-API-KEY-ID": apiKey, "APCA-API-SECRET-KEY": apiSecret };
  
  try {
    // Fetch 100 days to ensure enough trading days for a 30-day rolling window
    const url = "https://data.alpaca.markets/v2/stocks/" + ticker + "/bars?timeframe=1Day&limit=100&adjustment=all";
    const resp = UrlFetchApp.fetch(url, { "headers": headers, "muteHttpExceptions": true });
    
    if (resp.getResponseCode() !== 200) return [];
    
    const bars = JSON.parse(resp.getContentText()).bars;
    if (!bars || bars.length < 31) return [];

    // 1. Calculate daily percentage returns
    let returns = [];
    for (let i = 1; i < bars.length; i++) {
      let dailyReturn = (bars[i].c - bars[i-1].c) / bars[i-1].c;
      returns.push(dailyReturn);
    }

    // 2. Calculate rolling 30-day annualized volatility
    let volHistory = [];
    const windowSize = 30;
    
    for (let i = 0; i <= returns.length - windowSize; i++) {
      let window = returns.slice(i, i + windowSize);
      let mean = window.reduce((a, b) => a + b) / windowSize;
      let variance = window.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (windowSize - 1);
      
      // Annualized Volatility
      volHistory.push(Math.sqrt(variance) * Math.sqrt(252)); 
    }

    // Return the flat array directly
    return volHistory; 
  } catch (e) {
    return [];
  }
}
